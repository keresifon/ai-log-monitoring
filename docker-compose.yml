version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: ai-monitoring-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-ai_monitoring}
      POSTGRES_USER: ${POSTGRES_USER:-admin}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-admin} -d ${POSTGRES_DB:-ai_monitoring}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ai-monitoring-network

  redis:
    image: redis:7-alpine
    container_name: ai-monitoring-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    command: redis-server --appendonly yes ${REDIS_PASSWORD:+--requirepass $REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - ai-monitoring-network

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: ai-monitoring-elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=${ES_SECURITY_ENABLED:-false}
      - "ES_JAVA_OPTS=${ES_JAVA_OPTS:--Xms512m -Xmx512m}"
    ports:
      - "${ES_PORT:-9200}:9200"
      - "9300:9300"
    volumes:
      - es_data:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - ai-monitoring-network

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: ai-monitoring-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-admin}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-changeme}
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - ai-monitoring-network

  ml-service:
    build:
      context: ./backend/ml-service
      dockerfile: Dockerfile
    container_name: ai-monitoring-ml-service
    ports:
      - "${ML_SERVICE_PORT:-8000}:8000"
    volumes:
      - ml_models:/app/models
    environment:
      - MODEL_DIR=/app/models
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=${POSTGRES_DB:-ai_monitoring}
      - DB_USER=${POSTGRES_USER:-admin}
      - DB_PASSWORD=${POSTGRES_PASSWORD:-changeme}
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/api/v1/health || exit 1"]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3
    networks:
      - ai-monitoring-network
    depends_on:
      postgres:
        condition: service_healthy

  log-ingestion:
    build:
      context: ./backend/log-ingestion
      dockerfile: Dockerfile
    container_name: ai-monitoring-log-ingestion
    ports:
      - "${LOG_INGESTION_PORT:-8080}:8081"
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-docker}
      - DB_URL=jdbc:postgresql://postgres:5432/${POSTGRES_DB:-ai_monitoring}
      - DB_USERNAME=${POSTGRES_USER:-admin}
      - DB_PASSWORD=${POSTGRES_PASSWORD:-changeme}
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=${RABBITMQ_USERNAME:-guest}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-changeme}
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8081/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3
    networks:
      - ai-monitoring-network
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy

  log-processor:
    build:
      context: ./backend/log-processor
      dockerfile: Dockerfile
    container_name: ai-monitoring-log-processor
    ports:
      - "${LOG_PROCESSOR_PORT:-8082}:8082"
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-docker}
      - DB_URL=jdbc:postgresql://postgres:5432/${POSTGRES_DB:-ai_monitoring}
      - DB_USERNAME=${POSTGRES_USER:-admin}
      - DB_PASSWORD=${POSTGRES_PASSWORD:-changeme}
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_PORT=5672
      - RABBITMQ_USERNAME=${RABBITMQ_USERNAME:-guest}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-changeme}
      - ELASTICSEARCH_HOST=elasticsearch
      - ELASTICSEARCH_PORT=9200
      - ML_SERVICE_URL=http://ml-service:8000
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8082/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3
    networks:
      - ai-monitoring-network
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      ml-service:
        condition: service_healthy

  api-gateway:
    build:
      context: ./backend/api-gateway
      dockerfile: Dockerfile
    container_name: ai-monitoring-api-gateway
    ports:
      - "${API_GATEWAY_PORT:-8082}:8082"
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-docker}
      - LOG_INGESTION_URL=http://log-ingestion:8080
      - LOG_PROCESSOR_URL=http://log-processor:8081
      - ALERT_SERVICE_URL=http://alert-service:8083
      - ML_SERVICE_URL=http://ml-service:8000
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8082/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3
    networks:
      - ai-monitoring-network
    depends_on:
      log-ingestion:
        condition: service_healthy
      log-processor:
        condition: service_healthy

  alert-service:
    build:
      context: ./backend/alert-service
      dockerfile: Dockerfile
    container_name: ai-monitoring-alert-service
    ports:
      - "${ALERT_SERVICE_PORT:-8083}:8083"
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-docker}
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=${POSTGRES_DB:-ai_monitoring}
      - DB_USER=${POSTGRES_USER:-admin}
      - DB_PASSWORD=${POSTGRES_PASSWORD:-changeme}
      - SMTP_HOST=${SMTP_HOST:-smtp.gmail.com}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USERNAME=${SMTP_USERNAME:-}
      - SMTP_PASSWORD=${SMTP_PASSWORD:-}
      - EMAIL_ENABLED=${EMAIL_ENABLED:-false}
      - SLACK_ENABLED=${SLACK_ENABLED:-true}
      - WEBHOOK_ENABLED=${WEBHOOK_ENABLED:-true}
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8083/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3
    networks:
      - ai-monitoring-network
    depends_on:
      postgres:
        condition: service_healthy
      ml-service:
        condition: service_healthy

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  es_data:
    driver: local
  rabbitmq_data:
    driver: local
  ml_models:
    driver: local

networks:
  ai-monitoring-network:
    driver: bridge

# Made with Bob
